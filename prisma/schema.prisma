generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model WhatsAppAccount {
  id          String        @id @default(cuid())
  name        String
  phoneNumber String?       @unique
  status      AccountStatus @default(DISCONNECTED)
  qrCode      String?       @db.Text
  useLimits   Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  messages  Message[]
  contracts Contract[]

  @@index([status])
  @@map("whatsapp_accounts")
}

model Message {
  id        String          @id @default(cuid())
  accountId String
  account   WhatsAppAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  chatId        String?
  direction     MessageDirection?
  message       String            @db.Text
  to            String?
  from          String?
  status        MessageStatus     @default(PENDING)
  contactName   String?
  contactNumber String?

  sentAt    DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([accountId, chatId])
  @@index([status])
  @@index([sentAt])
  @@index([to])
  @@index([from])
  @@map("messages")
}

enum AccountStatus {
  DISCONNECTED
  CONNECTING
  QR_READY
  AUTHENTICATING
  CONNECTED
  FAILED
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum MessageStatus {
  PENDING
  SENT
  RECEIVED
  DELIVERED
  READ
  FAILED
}

model Contract {
  id        String          @id @default(cuid())
  accountId String
  account   WhatsAppAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name         String
  totalCount   Int
  successCount Int    @default(0)
  failureCount Int    @default(0)
  pendingCount Int    @default(0)

  status ContractStatus @default(PENDING)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  recipients ContractRecipient[]

  @@index([accountId])
  @@index([status])
  @@map("contracts")
}

model ContractRecipient {
  id         String   @id @default(cuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  phoneNumber String
  message     String          @db.Text
  status      RecipientStatus @default(PENDING)

  attempts     Int       @default(0)
  lastAttempt  DateTime?
  errorMessage String?   @db.Text

  messageId String?
  sentAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contractId])
  @@index([status])
  @@index([phoneNumber])
  @@map("contract_recipients")
}

enum ContractStatus {
  PENDING
  IN_PROGRESS
  PAUSED
  COMPLETED
  FAILED
}

enum RecipientStatus {
  PENDING
  QUEUED
  SENDING
  SUCCESS
  FAILED
}

model TelegramSubscriber {
  id        String   @id @default(cuid())
  chatId    String   @unique @map("chat_id")
  username  String?
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([chatId])
  @@index([isActive])
  @@map("telegram_subscribers")
}
